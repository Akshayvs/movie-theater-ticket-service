<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TicketServer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">movie-theater-ticket-service</a> &gt; <a href="index.source.html" class="el_package">default</a> &gt; <span class="el_source">TicketServer.java</span></div><h1>TicketServer.java</h1><pre class="source lang-java linenums">/**
 * Created by asonawane on 11/4/17.
 */

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ScheduledThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

<span class="fc" id="L11">public class TicketServer implements TicketService {</span>
    /*
    We are using a 2d array to represent the theater seating chart
    which is synchronized using a mutator function
    and
    a synchronized hashMap to store the mapping of seatHoldId to seats
    */
    // Syschrnoized Data Stores
<span class="fc" id="L19">    private Seats seats = new Seats();</span>
<span class="fc" id="L20">    private Map unconfirmedBookings = Collections.synchronizedMap(new HashMap&lt;Integer, SeatHold&gt;());</span>
<span class="fc" id="L21">    private static boolean[][] CHART = new boolean[10][10];</span>

    private static synchronized int[][] seatChartMutator(String command, int seatCount, int[][] seats) {

        /* ADD LOGIC
        To achieve a logical trade-of between theater utilization and best seat; the approach used is to iterate from top all the way till the last row
        while allocating the first possible seat to the seat requester. This solves two purposes,
        1. Theater utilization is maximized
        2. Customer satisfaction is increased by providing them with the farthest possible row from the screen.
        */
<span class="pc bpc" id="L31" title="1 of 2 branches missed.">        if (command.equals(&quot;add&quot;)) {</span>
<span class="fc" id="L32">            int[][] bookedSeats = new int[seatCount][2];</span>

<span class="fc" id="L34">            int index = 0;</span>
<span class="pc bpc" id="L35" title="1 of 2 branches missed.">            for (int row = 0; row &lt; 10; row++) {</span>

<span class="pc bpc" id="L37" title="1 of 2 branches missed.">                for (int column = 0; column &lt; 10; column++) {</span>
<span class="fc bfc" id="L38" title="All 2 branches covered.">                    if (CHART[row][column] == false) {</span>
<span class="fc" id="L39">                        CHART[row][column] = true;</span>

<span class="fc" id="L41">                        int[] seatLocation = {row, column};</span>

<span class="fc" id="L43">                        bookedSeats[index] = seatLocation;</span>
<span class="fc" id="L44">                        index++;</span>
<span class="fc bfc" id="L45" title="All 2 branches covered.">                        if (index == seatCount) {</span>
<span class="fc" id="L46">                            return bookedSeats;</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L51" title="All 2 branches missed.">        } else if (command.equals(&quot;remove&quot;)) {</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            for (int[] seat : seats) {</span>
<span class="nc" id="L53">                int row = seat[0];</span>
<span class="nc" id="L54">                int column = seat[1];</span>

<span class="nc" id="L56">                CHART[row][column] = false;</span>
            }
<span class="nc" id="L58">            return null;</span>
        }
<span class="nc" id="L60">        return null;</span>
    }

    public int totalAvailableSeats() {
<span class="fc" id="L64">        return seats.getSeatCount();</span>
    }

    public SeatHold findAndHoldSeats(int totalSeatsRequested, String customerEmail) {
<span class="fc bfc" id="L68" title="All 2 branches covered.">        if (seats.getSeatCount() - totalSeatsRequested &gt;= 0) {</span>
            // update totalSeats counter, update the seatChart, create a booking Object and map it in the unconfirmedBookings map`

<span class="fc" id="L71">            seats.setSeatCount(-totalSeatsRequested);</span>
<span class="fc" id="L72">            int seatsOnHold[][] = seatChartMutator(&quot;add&quot;, totalSeatsRequested, null);</span>
<span class="fc" id="L73">            final SeatHold booking = new SeatHold(totalSeatsRequested, customerEmail, seatsOnHold);</span>
<span class="fc" id="L74">            unconfirmedBookings.put(booking.getSeatHoldId(), booking);</span>


            // TIMEOUT !!
<span class="fc" id="L78">            ScheduledThreadPoolExecutor exec = new ScheduledThreadPoolExecutor(1);</span>
<span class="fc" id="L79">            exec.schedule(new Runnable() {</span>
                public void run() {
                    /*
                    Delete entry from unconfirmedBookings map, Update the count, update the 2d seatChart array
                    */
<span class="nc bnc" id="L84" title="All 2 branches missed.">                    if (unconfirmedBookings.containsKey(booking.getSeatHoldId())) {</span>
<span class="nc" id="L85">                        seats.setSeatCount(booking.getNumberOfSeats());</span>
<span class="nc" id="L86">                        unconfirmedBookings.remove(booking.getSeatHoldId());</span>
<span class="nc" id="L87">                        seatChartMutator(&quot;remove&quot;, 0, booking.getSeatsOnHold());</span>
                    }
<span class="nc" id="L89">                }</span>
            }, 15, TimeUnit.SECONDS);
<span class="fc" id="L91">            return booking;</span>
        } else {
            // error response passing logic to provide a negated count of the actual remaining seats.
<span class="fc" id="L94">            return new SeatHold(-seats.getSeatCount(), customerEmail, null);</span>
        }
    }

    public String reserveSeats(int seatHoldId, String customerEmail) {
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (unconfirmedBookings.containsKey(seatHoldId)) {</span>
<span class="fc" id="L100">            unconfirmedBookings.remove(seatHoldId);</span>
<span class="fc" id="L101">            return &quot;Seats are Booked&quot;;</span>
        } else {
<span class="fc" id="L103">            return &quot;Invalid Id, your reservation hold might have expired&quot;;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>